---
title: "fish_survey"
author: "Charles Hendrickson"
date: "2/24/2022"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# load packages
librarian::shelf(ggplot2,lubridate, tidyverse, janitor, plotly)
```


The data is from the Environmental Data Initiative data portal. https://portal.edirepository.org/nis/mapbrowse?packageid=knb-lter-mcr.6.61

The Anual Fish Survey data contains fish transect visual counts repeated annually include species, fish length, estimated biomass, and trophic group.
```{r}
# load data
annual_fish_survey_data <- read.csv("data/MCR_LTER_Annual_Fish_Survey_20220119.csv")

percent_cover_data <- read.csv("data/knb-lter-mcr.4_2_20190321.csv")

```


```{r}
# explore data
str(annual_fish_survey_data)
```

Clean data column names and change data type of the column 'site' from numeric to a factor
```{r}
# make all column names lowercase 
annual_fish_survey_data <- annual_fish_survey_data %>%
  clean_names()

percent_cover_data <- percent_cover_data %>% 
  clean_names()

# Change data type of the column 'site' from numeric to a factor
annual_fish_survey_data$site <- as.factor(annual_fish_survey_data$site)


```

Get substring of the 'location' column 
https://www.datasciencemadesimple.com/substring-function-in-r/

```{r}
# We only want "LTER #" 
# Below I used substr() function to find first n characters of the column in R. substr() function takes column name, starting position and length of the strings as argument, which will return the substring of the specific column as shown below.

annual_fish_survey_data$substring_location = 
  substr(annual_fish_survey_data$location,1,6)

percent_cover_data$substring_location = 
  substr(percent_cover_data$location,1,6)

# We only want the year, not the month so create of substring of the year column. 
percent_cover_data <- percent_cover_data %>%
  separate(date, c("year", "month"), "-")

```


Select/Filter data 
```{r}
# Group by year, site, and biomass
annual_biomass_data <- annual_fish_survey_data %>%
  filter(coarse_trophic == "Primary Consumer") %>% 
  group_by(year, substring_location) %>%
  summarise(mean_biomass = mean(biomass))


# Select for only Macroalgae 
macroalgae_percent_cover_data <- percent_cover_data %>% 
  select(year, substring_location, macroalgae)

```


Find the average macroalgae percent cover at LTER 1 each year 
```{r}
# Find the average macroalgae percent cover at LTER 1 each year 
macroalgae_LTER1 <- macroalgae_percent_cover_data %>% 
  filter(substring_location == "LTER 1") %>% 
  group_by(year,substring_location) %>% 
  summarise(avg_pct_cover = mean(macroalgae))

```

Find the mean primary consumer fish biomass each year for LTER site 1
```{r}
# Find the mean biomass for site 1 each year 
avg_biomass_LTER1 <- annual_fish_survey_data %>%
  filter(coarse_trophic == "Primary Consumer", substring_location == "LTER 1") %>% 
  group_by(year, substring_location) %>%
  summarise(mean_biomass = mean(biomass))
```


```{r}
ggplot(data = macroalgae_LTER1, aes(x = year, y = avg_pct_cover)) +
  geom_point() + 
  geom_line(aes(group = substring_location)) +
  labs(title = "Average Macroalgae Percent Cover in Moorea, French Polynesia (2006-2021)",
       x = "Year",
       y = "Average Percent Cover (%)") +
  theme_bw()
```


```{r}
ggplot(data = avg_biomass_LTER1, aes(x = year, y = mean_biomass)) +
  geom_point() +
  geom_line(aes(group = substring_location)) +
  labs(title = "Average Biomass of Primary Consumer Fish in Moorea, French Polynesia 
(2006-2021)",
       x = "Year",
       y = "Average Biomass (grams)") +
  theme_bw()
```


Line chart 
```{r}
# Plot biomass by year and color the sites
biomass_plot <- ggplot(data = annual_biomass_data, 
                       aes(x = year, y = mean_biomass, color = substring_location)) +
  geom_point() + 
  geom_line(aes(group = substring_location)) +
  labs(title = "Fish Biomass in Moorea, French Polynesia (2006-2021)",
       x = "Year",
       y = "Average Biomass")


# Make plot interactive 
ggplotly(biomass_plot)
```


Stacked bar chart 
```{r}
# Plot biomass by year and color the sites
biomass_plot2 <- ggplot(data = annual_biomass_data, aes(x = year, y = mean_biomass, fill = substring_location)) +
  geom_bar(position="stack", stat="identity") +
  labs(title = "Fish Biomass in Moorea, French Polynesia (2006-2021)",
       x = "Year",
       y = "Average Biomass")


# Make plot interactive 
ggplotly(biomass_plot2)
```


Anomaly of mean biomass  
```{r}
# Find the mean biomass of each site across all years 
avg_biomass_per_site <- annual_fish_survey_data %>%
  filter(coarse_trophic == "Primary Consumer") %>% 
  group_by(site) %>%
  summarise(mean_biomass = mean(biomass))

# In the 'avg_biomass_s1' data frame, subtract the mean biomass of site 1 across all years 'avg_biomass_total$mean_biomass'by the mean biomass for site 1 each year (Normalize the site 1 data to make an anomaly)

avg_biomass_LTER1 <- avg_biomass_LTER1 %>% 
  mutate("biomass_anomaly" = mean_biomass - 194.0221,
         "Anomaly" = ifelse(biomass_anomaly > 0, "Above Avg.", "Below Avg."))

```

Plot biomass anomaly from site 1 
```{r}
ggplot(data = avg_biomass_LTER1, aes(x = year, y = biomass_anomaly)) +
  geom_bar(stat = "identity", position = "identity", aes(fill = Anomaly)) +
  scale_fill_manual(name = "Anomaly",values=c("Above Avg." = "steelblue", "Below Avg." = "firebrick1")) +
  labs(title = "Biomass Anomaly of Primary Consumer Fish in Moorea, French Polynesia 
LTER Site 1 (2006-2021)",
       x = "Year",
       y = "Biomass Anomaly (grams)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```



```{r}
# Find mean biomass of all years 
mean_biomass_total <- annual_fish_survey_data %>% 
  filter(coarse_trophic == "Primary Consumer") %>% 
  summarise(mean_biomass = mean(biomass))

as.numeric(mean_biomass_total)
```

Find the mean primary consumer fish biomass each year 
```{r}
# Find the mean biomass each year 
avg_biomass_per_year <- annual_fish_survey_data %>%
  filter(coarse_trophic == "Primary Consumer") %>% 
  group_by(year) %>%
  summarise(mean_biomass = mean(biomass)) %>% 
  mutate("biomass_anomaly" = mean_biomass - 186.1223,
         "Anomaly" = ifelse(biomass_anomaly > 0, "Above Avg.", "Below Avg."))
```


Plot biomass anomaly 2006-2021
```{r}
# Plot biomass anomaly 2006-2021
anomaly_plot <- ggplot(data = avg_biomass_per_year, aes(x = year, y = biomass_anomaly)) +
  geom_bar(stat = "identity", position = "identity", aes(fill = Anomaly)) +
  scale_fill_brewer(palette = "Set2") +
  #scale_fill_manual(values=c("Above Avg." = "steelblue", "Below Avg." = "firebrick1")) +
  geom_vline(xintercept = 5, linetype = "dotdash", alpha = .5) +
  annotate("text", x = 6.05, y = 12, label = "Cyclone Oli", size = 3, alpha = .5) +
  annotate("rect", xmin = 1, xmax = 4, ymin = -Inf, ymax = Inf,
           alpha = .3,fill = "red") +
  annotate("text", x = 2.5, y = 12, label = "Crown of Thorns
Outbreak", size = 3, colour = "red", alpha = .5) +
  labs(title = "Herbivorous Reef Fish Biomass Anomaly",
  subtitle = "Moorea, French Polynesia (2006-2021)",
       x = "Year",
       y = "Fish Biomass Anomaly (gm^2)") +
  theme_bw() +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  theme(plot.title = element_text(vjust = 1)) # Change vertical position

anomaly_plot


# Plotly
ggplotly(anomaly_plot) %>%
  layout(title = list(text = paste0('Herbivorous Reef Fish Biomass Anomaly',
                                    '<br>',
                                    '<sup>',
                                    'Moorea, French Polynesia (2006-2021)',
                                    '</sup>'))) %>% 
    add_annotations( text="Anomaly", xref="paper", yref="paper",
                  x=1.05, xanchor="left",
                  y=0.8, yanchor="bottom",    # Same y as legend below
                  legendtitle=TRUE, showarrow=FALSE ) %>%
  layout(legend=list(y=0.8, yanchor="top"))

```


Final non-interactive plot 
```{r}
# Plot biomass anomaly 2006-2021
anomaly_plot <- ggplot(data = avg_biomass_per_year, aes(x = year, y = biomass_anomaly)) +
  geom_bar(stat = "identity", position = "identity", aes(fill = Anomaly)) +
  scale_fill_brewer(palette = "Set2") +
  #scale_fill_manual(values=c("Above Avg." = "steelblue", "Below Avg." = "firebrick1")) +
  geom_vline(xintercept = 5, linetype = "dotdash", alpha = .5) +
  annotate("text", x = 6.05, y = 12, label = "Cyclone Oli", size = 3, alpha = .5) +
  annotate("rect", xmin = 1, xmax = 4, ymin = -Inf, ymax = Inf,
           alpha = .3,fill = "red") +
  annotate("text", x = 2.5, y = 12, label = "Crown of Thorns
Outbreak", size = 3, colour = "red", alpha = .5) +
  labs(title = "Herbivorous Reef Fish - Annual Biomass Anomalies",
  subtitle = "Moorea, French Polynesia (2006-2021)",
  caption = "Figure 3: Annual biomass anomalies for herbivorous reef fish in Moorea",
       x = "Year",
       y = "Fish Biomass Anomaly (gm^2)") +
  theme_bw() +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  theme(plot.title = element_text(vjust = 1)) # Change vertical position

anomaly_plot
```





Fig 1. The average biomass (grams) of herbivorous reef fish since 2006 as compared to the average biomass taken from 2006 to 2021. Anomaly in biomass refers to the comparison for a given place and time with the equivalent average biomass for that place and time, based on data from a particular span of time. So an anomaly of +20 grams would mean that the biomass was +20 grams higher that year than the average in the time span from 2006-2021. 

























